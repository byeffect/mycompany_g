MODULE SchedulerNotification;

REQUIRE Scheduler, TelegramCustom, ProductLot;

NAMESPACE Scheduler;

chat = DATA Chat (ScheduledTask);
nameChat '–ß–∞—Ç –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π' (ScheduledTask t)= name(chat(t));


notifyFailure '–£–≤–µ–¥–æ–º–ª—è—Ç—å –æ–± –æ—à–∏–±–∫–µ' = DATA BOOLEAN (ScheduledTask);

EXTEND FORM scheduledTask
    PROPERTIES(t) notifyFailure, nameChat
;

message (ScheduledTaskLog l) = CONCAT '\n', '----------------','‚óΩÔ∏è–ó–∞–¥–∞–Ω–∏–µ: ' + nameScheduledTask(l), '‚óΩÔ∏è–î–µ–π—Å—Ç–≤–∏–µ: ' + property(l), '‚óΩÔ∏è–†–µ–∑—É–ª—å—Ç–∞—Ç: ' + result(l),
    '‚óΩÔ∏è–î–æ–ø –∏–º–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n' +  (GROUP CONCAT STRING[800] ((IF failed(ScheduledClientTaskLog ll) THEN 'üî¥'  ELSE '‚ö™' ) + message(ll)) IF scheduledTaskLog(ll) = l , '\n' ORDER failed(ll));

WHEN SET(exceptionOccurred(ScheduledTaskLog l) OR (isFailed(l))) AND notifyFailure(scheduledTask(l))
    AND chat(scheduledTask(l)) DO sendMessage(chat(scheduledTask(l)), STRING[4000](message(l)));
